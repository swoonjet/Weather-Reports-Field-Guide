<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>World C6H-ɛ Field Guide</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --base-color: #EDE9DC;
      --bright-field: #FCFBF8;
      --dieter-gray: #504C4C;
      --text-color: #000000;
      --font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      --story-font: 'Crimson Pro', serif;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--base-color);
      color: var(--text-color);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Content Sections */
    .content-area { opacity: 1; transition: opacity 0.5s ease; }
    .content-area.hidden { opacity: 0; pointer-events: none; position: absolute; width: 100%; }
    .story-reader-content { width: 100%; max-width: 980px; margin: 40px auto 80px; padding: 0 20px; }
    .container { width: 100%; max-width: 1440px; margin: 0 auto; position: relative; background: var(--base-color); padding-bottom: 40px; }

    /* Header Section */
    .header-section { width: 100%; max-width: 1152px; height: 96px; margin: 136px auto 0; position: relative; padding: 0 20px; }
    .main-title { position: absolute; left: 0; top: 13px; color: var(--text-color); font-size: 36px; font-weight: 700; line-height: 1.2; }
    .weather-title { position: absolute; right: 0; top: 14px; color: var(--text-color); font-size: 36px; font-weight: 700; line-height: 1.2; }
    .divider-line { position: absolute; left: 0; right: 0; top: 72px; height: 2px; background-color: var(--text-color); }

    /* Progress Bar Section */
    .progress-section { width: 100%; max-width: 1004px; margin: 72px auto 0; padding: 0 20px; position: relative; }
    .progress-label {
      position: absolute; top: -26px; left: 50%; transform: translateX(-50%);
      text-align: center; width: max-content;
      color: var(--text-color); font-size: 14px; font-weight: 700;
    }
    .progress-container { width: 100%; height: 16px; background: var(--base-color); border: 1px solid var(--text-color); border-radius: 8px; overflow: hidden; position: relative; }
    .progress-fill { width: 69%; height: 100%; background: var(--dieter-gray); border-radius: 7px; transition: width 0.3s ease; }
    .progress-value { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--base-color); font-size: 10px; font-weight: 700; }

    /* Behavioral Matrix Section */
    .behavioral-matrix { width: 100%; max-width: 1004px; margin: 20px auto; padding: 0 20px; position: relative; }
    .matrix-button {
      width: 100%; height: 76px;
      background: var(--base-color);
      border: 1px solid var(--dieter-gray);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; position: relative; overflow: hidden;
      transition: border-color .2s ease, background-color .2s ease;
    }
    /* SUBTLE hover: no bounce, no shadow */
    .matrix-button:hover {
      background-color: var(--bright-field);
      border-color: var(--text-color);
    }
    .matrix-text {
      color: var(--text-color);
      font-size: 14px; font-weight: 590; letter-spacing: 10.36px;
      text-align: center; transition: letter-spacing .15s ease, font-weight .15s ease;
    }
    .matrix-button:hover .matrix-text { letter-spacing: 11px; font-weight: 600; }

    /* Small caret that rotates when open (subtle) */
    .matrix-caret {
      position: absolute; right: 14px; top: 50%;
      transform: translateY(-50%) rotate(0deg);
      transition: transform .2s ease, color .2s ease; font-size: 14px;
      color: var(--dieter-gray);
      pointer-events: none;
    }
    .behavioral-matrix.open .matrix-caret {
      transform: translateY(-50%) rotate(180deg);
      color: var(--text-color);
    }

    /* Attached look when open */
    .behavioral-matrix.open .matrix-button{
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom-color: transparent;
    }

    /* Drop panel */
    .matrix-panel{
      border: 1px solid var(--dieter-gray);
      border-top: none;
      border-radius: 0 0 8px 8px;

      overflow: hidden;
      max-height: 0;
      opacity: 0;
      padding: 0 20px;
      background: var(--base-color);

      transition: max-height .28s ease, opacity .18s ease, padding .2s ease;
    }
    .behavioral-matrix.open .matrix-panel{
      max-height: 520px;
      opacity: 1;
      padding: 16px 20px 20px;
    }

    /* Grid of tiles */
    .matrix-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }
    .matrix-tile {
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      text-align: center;
      background: var(--bright-field);
      border: 1px solid rgba(80, 76, 76, 0.3);
      border-radius: 8px;
      padding: 10px;
      min-height: 56px;
      font-size: 12px; font-weight: 510; color: var(--text-color);
      cursor: pointer; transition: border-color .2s ease, background-color .2s ease; position: relative;
    }
    .matrix-tile:hover:not(:disabled){ background: #fffdf7; border-color: var(--dieter-gray); }
    .matrix-tile:disabled { opacity: 0.35; cursor: not-allowed; }
    .matrix-count {
      font-size: 11px; font-weight: 600;
      position: absolute; bottom: 6px; right: 8px;
      color: var(--dieter-gray); opacity: 0.8;
    }

    /* Centered chip (hidden while panel open) */
    .matrix-chipbar{
      display: none;
      margin-top: 14px;
      justify-content: center;
    }
    .matrix-chipbar.show{ display: flex; }
    .behavioral-matrix.open .matrix-chipbar{ display: none !important; }

    .filter-chip{
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--bright-field);
      border: 1px solid var(--dieter-gray);
      border-radius: 16px;
      padding: 6px 12px;
      font-size: 12px; font-weight: 500; color: var(--text-color);
    }
    .filter-chip button{
      border: none; background: none; color: var(--text-color);
      font-size: 16px; cursor: pointer; line-height: 1;
    }
    .filter-chip button:hover{ opacity: .6; }

    /* Card Grid */
    .card-grid { width: 100%; max-width: 1200px; margin: 40px auto 0; padding: 0 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 24px; }
    .correspondent-card { width: 100%; height: 277px; background: var(--bright-field); border-radius: 8px; padding: 22px; position: relative; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; text-decoration: none; color: inherit; border: 1px solid rgba(80, 76, 76, 0.25); }
    .card-grid-container { position: absolute; bottom: 15px; left: 15px; right: 15px; top: 110px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    .card-grid-dots { position: relative; width: 140px; height: 140px; }
    .card-dot { position: absolute; width: 2px; height: 2px; background-color: rgba(80, 76, 76, 0.3); border-radius: 50%; pointer-events: none; }
    .correspondent-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(80, 76, 76, 0.15); }
    .card-title { color: var(--dieter-gray); font-size: 14px; font-weight: 700; margin-bottom: 15px; transition: all 0.3s ease; position: relative; z-index: 2; }
    .card-role { color: var(--dieter-gray); font-size: 10px; font-style: italic; font-weight: 400; margin-bottom: 5px; opacity: 0.8; transition: all 0.3s ease; position: relative; z-index: 2; }
    .card-name { color: var(--dieter-gray); font-size: 12px; font-style: italic; font-weight: 400; transition: all 0.3s ease; position: relative; z-index: 2; }
    .correspondent-card:hover .card-title { color: var(--text-color); transform: translateY(-2px); }
    .correspondent-card:hover .card-role, .correspondent-card:hover .card-name { color: var(--text-color); opacity: 1; }

    /* Story Reader Styles */
    .back-button { background: none; border: none; color: var(--text-color); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; text-decoration: none; transition: opacity 0.3s ease; margin-bottom: 20px; }
    .back-button:hover { opacity: 0.7; }
    .back-button::before { content: "←"; font-size: 16px; }
    .story-container { max-width: 980px; margin: 0 auto; padding: 0 20px; }
    .story-header { margin-bottom: 40px; }
    .story-title { color: var(--text-color); font-size: 36px; font-family: var(--font-family); font-weight: 700; margin-bottom: 15px; line-height: 1.2; }
    .story-author { color: var(--dieter-gray); font-size: 16px; font-style: italic; font-weight: 400; margin-bottom: 6px; }
    .story-role { color: var(--dieter-gray); font-size: 20px; font-style: italic; font-weight: 500; }
    .story-content { color: var(--dieter-gray); font-size: 24px; font-family: var(--story-font); font-weight: 400; line-height: 1.4; margin-bottom: 40px; }
    .story-content p { margin-bottom: 0; text-indent: 2em; }
    .story-content p:first-child { text-indent: 2em; }
    .story-content em { font-style: italic; }
    .story-content strong { font-weight: 700; }
    .story-content hr { border: none; border-top: 1px solid rgba(80,76,76,.45); margin: 20px 0; }

    figure.story-audio { background: transparent; border:1px solid rgba(80,76,76,.15); border-radius:12px; padding:12px 14px; margin:20px 0 28px; }
    figure.story-audio figcaption { font-size:12px; color:var(--dieter-gray); margin-bottom:8px; font-weight:700; }
    figure.story-audio audio { width:100%; outline:none; display:block; }

    .story-nav { display: flex; gap: 20px; justify-content: center; background: var(--bright-field); padding: 12px 24px; border-radius: 40px; border: 1px solid rgba(80, 76, 76, 0.1); margin: 0 auto; width: fit-content; }
    .nav-button { background: none; border: none; color: var(--text-color); font-size: 12px; font-weight: 600; cursor: pointer; padding: 6px 12px; border-radius: 20px; transition: all 0.3s ease; text-decoration: none; }
    .nav-button:hover { background: var(--base-color); }
    .nav-button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Animation for cards appearing */
    .correspondent-card { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.6s ease forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    .correspondent-card:nth-child(1) { animation-delay: 0.1s; }
    .correspondent-card:nth-child(2) { animation-delay: 0.2s; }
    .correspondent-card:nth-child(3) { animation-delay: 0.3s; }
    .correspondent-card:nth-child(4) { animation-delay: 0.4s; }
    .correspondent-card:nth-child(5) { animation-delay: 0.5s; }
    .correspondent-card:nth-child(6) { animation-delay: 0.6s; }
    .correspondent-card:nth-child(7) { animation-delay: 0.7s; }
    .correspondent-card:nth-child(8) { animation-delay: 0.8s; }
    .correspondent-card:nth-child(9) { animation-delay: 0.9s; }
    .correspondent-card:nth-child(10) { animation-delay: 1.0s; }
    .correspondent-card:nth-child(11) { animation-delay: 1.1s; }
    .correspondent-card:nth-child(12) { animation-delay: 1.2s; }
    .correspondent-card:nth-child(13) { animation-delay: 1.3s; }
    .correspondent-card:nth-child(14) { animation-delay: 1.4s; }
    .correspondent-card:nth-child(15) { animation-delay: 1.5s; }
    .correspondent-card:nth-child(16) { animation-delay: 1.6s; }
    .correspondent-card:nth-child(17) { animation-delay: 1.7s; }
    .correspondent-card:nth-child(18) { animation-delay: 1.8s; }
    .correspondent-card:nth-child(19) { animation-delay: 1.9s; }
    .correspondent-card:nth-child(20) { animation-delay: 2.0s; }

    /* Full-bleed strip behind the story */
    .story-reader-content {
      width: 100vw; max-width: none;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      background: var(--bright-field);
      padding: 48px 0 64px;
      border-top: 1px solid rgba(80,76,76,.12);
      border-bottom: 1px solid rgba(80,76,76,.12);
    }
    .story-reader-content .story-container { max-width: 980px; margin: 0 auto; padding: 0 4%; }
    .story-reader-content .back-button{ display:block; width:100%; max-width:980px; margin:0 auto 48px; padding:0 4%; text-align:left; }

    /* Lightbox overlay */
    .lightbox-backdrop{
      position:fixed; inset:0; z-index:9999;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.85); padding:4vw;
    }
    .lightbox-backdrop.open{ display:flex; }
    .lightbox-img{ max-width:100%; max-height:100%; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.4); }
    .lightbox-close{
      position:absolute; top:14px; right:16px; width:auto; height:auto;
      background:transparent; border:0; color:#fff; font-size:30px; line-height:1; cursor:pointer;
    }
    .story-content img{ max-width:100%; height:auto; display:block; cursor: zoom-in; }

    /* Responsive tweaks */
    @media (max-width: 768px){
      .progress-label { top: -22px; }
      .container { padding: 20px 0; }
      .header-section { height: auto; margin-top: 60px; }
      .main-title { position: static; margin-bottom: 20px; font-size: 24px; text-align: center; }
      .weather-title { position: static; font-size: 24px; text-align: center; margin-bottom: 30px; }
      .divider-line { position: static; margin: 20px 0; }
      .card-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .matrix-text { font-size: 12px; letter-spacing: 8px; }
      .matrix-button:hover .matrix-text { letter-spacing: 10px; }
      .story-title { font-size: 28px; }
      .story-content { font-size: 20px; }
      .story-reader-content .back-button{ margin-bottom:40px; padding:0 4%; }
    }
    @media (max-width: 480px) {
      .card-grid { grid-template-columns: 1fr; max-width: 400px; }
      .main-title, .weather-title { font-size: 20px; }
      .matrix-text { font-size: 10px; letter-spacing: 6px; }
      .matrix-button:hover .matrix-text { letter-spacing: 8px; }
      .story-title { font-size: 24px; }
      .story-content { font-size: 18px; }
    }
    /* Site brief under header – matches story text column width */
.site-brief{
  width: 100%;
  max-width: 980px;    /* same as .story-container */
  margin: 24px auto 18px;
  padding: 0 20px;     /* same side padding as .story-container */
}

/* Larger, story-style typography */
.site-brief p{
  font-family: var(--story-font);
  font-size: 24px;     /* same as .story-content for readability */
  line-height: 1.45;
  color: var(--dieter-gray);
}

@media (max-width: 768px){
  .site-brief{ margin-top: 18px; }
  .site-brief p{ font-size: 21px; line-height: 1.5; }
}
/* === Swarm (disperse → snap back) =============================== */
:root{
  --swarm-hover: 420ms;   /* how fast dots fly out */
  --swarm-return: 180ms;  /* how fast dots snap back */
}

.card-grid-container{ overflow: visible; }      /* let dots escape a bit */
.card-grid-dots{ position: relative; overflow: visible; } /* same */

.card-dot{
  /* keep your color; bump size if you like: 4–6px is nice */
  width: 4px; height: 4px;
  border-radius: 50%;
  background-color: rgba(80,76,76,0.35);
  position: absolute;
  will-change: transform, opacity;
  transform: translate(0,0);
  transition:
    transform var(--swarm-hover) cubic-bezier(.2,.6,.2,1),
    opacity 220ms ease;
  pointer-events: none;
}

/* When snapping back, shorten/retime the transition so it “sucks” in */
.correspondent-card.sucking .card-dot{
  transition-duration: var(--swarm-return);
  transition-timing-function: cubic-bezier(.3,.8,.2,1.15);
}
    /* === Recruit Button === */
.fg-recruit-button{
  position:fixed;
  right:20px; bottom:24px;
  width:18px; height:18px;   /* 40% of 44px */
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  background:var(--bright-field);
  color:var(--text-color);
  border:1px solid rgba(80,76,76,.35);
  box-shadow:0 4px 12px rgba(80,76,76,.15);
  text-decoration:none;
  font-weight:700; font-size:9px; line-height:1; /* also scale down text */
  transition:transform .12s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
  z-index:9000;
}
.fg-recruit-button:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 20px rgba(80,76,76,.18);
  border-color:rgba(80,76,76,.5);
}
.fg-recruit-button:focus-visible{
  outline:2px solid var(--text-color);
  outline-offset:2px;
}
@media (max-width:480px){
  .fg-recruit-button{ right:14px; bottom:16px; }
}

  </style>
</head>
<body>
  <div class="container">
    <!-- Header Section -->
    <div class="header-section">
      <h1 class="main-title">World C6H-ɛ Field Guide</h1>
      <h2 class="weather-title">Weather Reports</h2>
      <div class="divider-line"></div>
    </div>
    <!-- Site brief (below header divider) -->
<div class="site-brief">
  <p>
    Subjects exhibit diverse adaptive responses with several anomalous behavioral clusters requiring closer analysis.
    Recommend sustained sensory veil and interference protocols. 
  </p>
</div>


    <!-- Progress Bar Section -->
    <div class="progress-section">
      <div class="progress-label">Integration Threshold</div>
      <div class="progress-container">
        <div class="progress-fill"></div>
        <div class="progress-value">67</div>
      </div>
    </div>

    <!-- Behavioral Matrix Section -->
    <div class="behavioral-matrix">
      <button class="matrix-button" onclick="expandMatrix()">
        <div class="matrix-text">BEHAVIORAL MATRIX</div>
        <span class="matrix-caret" aria-hidden="true">▾</span>
      </button>
      <div class="matrix-panel" id="matrix-panel"></div>
      <div class="matrix-chipbar" id="matrix-chipbar"></div>
    </div>

    <!-- Card Grid -->
    <div class="content-area" id="card-grid-area">
      <div class="card-grid" id="card-grid"></div>
    </div>

    <!-- Story Reader Content -->
    <div class="content-area hidden" id="story-reader-area">
      <div class="story-reader-content">
        <button class="back-button" onclick="showCardGrid()">Back to Field Guide</button>
        <div class="story-container">
          <div class="story-header">
            <h1 class="story-title" id="story-title">Story Title</h1>
            <div class="story-author" id="story-author">reported by</div>
            <div class="story-role" id="story-role">Author Name</div>
          </div>
          <div class="story-content" id="story-content"><p>Story content will appear here...</p></div>
          <div class="story-nav">
            <button class="nav-button" id="prev-story" onclick="navigateStory(-1)">← Previous</button>
            <button class="nav-button" id="next-story" onclick="navigateStory(1)">Next →</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Base interaction scripts -->
  <script>
    // Globals needed across modules & inline handlers
    let currentStoryIndex = 0;
    let storyList = [];

    function showStoryByIndex(idx){ if(idx>=0 && idx<storyList.length){ openStory(idx); } }

    function showCardGrid() {
      document.getElementById('story-reader-area').classList.add('hidden');
      document.getElementById('card-grid-area').classList.remove('hidden');
      document.title = 'World C6H-ɛ Field Guide';
      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
    }
    function navigateStory(direction) { showStoryByIndex(currentStoryIndex + direction); }
    function updateStoryNavigation() {
      const prevButton = document.getElementById('prev-story');
      const nextButton = document.getElementById('next-story');
      prevButton.style.display = currentStoryIndex > 0 ? 'inline-block' : 'none';
      nextButton.style.display = currentStoryIndex < storyList.length - 1 ? 'inline-block' : 'none';
    }
    function expandMatrix() {
      // no bounce or shadow — tiny letter-spacing nudge
      const text = document.querySelector('.matrix-text');
      if (text){
        const prev = getComputedStyle(text).letterSpacing;
        text.style.letterSpacing = '11px';
        setTimeout(()=>{ text.style.letterSpacing = prev; }, 140);
      }
    }

    window.showCardGrid = showCardGrid;
    window.navigateStory = navigateStory;
    window.showStoryByIndex = showStoryByIndex;
  </script>

  <!-- Gentle progress bar -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fill = document.querySelector('.progress-fill');
      const value = document.querySelector('.progress-value');
      let current = parseInt(value.textContent, 10) || 67;
      function step() {
        const dir = Math.random() < 0.5 ? -1 : 1;
        let next = current + dir;
        if (next > 80) next = 80;
        if (next < 0) next = 0;
        current = next;
        fill.style.width = current + '%';
        value.textContent = String(current);
        const wait = 3000 + Math.random() * 5000;
        setTimeout(step, wait);
      }
      setTimeout(step, 2000);
    });
  </script>

  <!-- Manifest-driven content loader -->
  <script src="https://unpkg.com/dompurify@3.1.6/dist/purify.min.js"></script>
  <script>
  (function(){
    const MANIFEST_URL = 'stories/stories.manifest.json';
    let MANIFEST = [];
    let lightboxOpen = false, lightboxEl = null, lightboxImg = null;

    function shuffle(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    async function loadManifest(){
      const res = await fetch(MANIFEST_URL, { cache: 'no-cache' });
      if(!res.ok) throw new Error('Failed to load stories.manifest.json');
      MANIFEST = await res.json();
      return MANIFEST;
    }

    function dotGrid(into){
      const gridSize = 10, gridW = 140, gridH = 140;
      const stepX = gridW/(gridSize+1), stepY = gridH/(gridSize+1);
      for(let r=1;r<=gridSize;r++){
        for(let c=1;c<=gridSize;c++){
          const dot = document.createElement('div');
          dot.className = 'card-dot';
          dot.style.left = (c*stepX)+'px';
          dot.style.top  = (r*stepY)+'px';
          into.appendChild(dot);
        }
      }
    }

    async function buildCards(){
      const list = await loadManifest();
      storyList = shuffle([...list]);

      const grid = document.getElementById('card-grid');
      grid.innerHTML = '';

      storyList.forEach((s, idx)=>{
        const card = document.createElement('div');
        card.className = 'correspondent-card';
        card.setAttribute('data-idx', idx);
        card.setAttribute('data-key', s.html);
        card.onclick = () => openStory(idx);
        card.innerHTML = `
          <div class="card-title">${s.title || ''}</div>
          <div class="card-role">reported by</div>
          <div class="card-name">${s.author || ''}</div>
          <div class="card-grid-container"><div class="card-grid-dots"></div></div>
        `;
        dotGrid(card.querySelector('.card-grid-dots'));
        grid.appendChild(card);
      });
    }

    function setupLightbox(){
      if (lightboxEl) return;
      lightboxEl = document.createElement('div');
      lightboxEl.className = 'lightbox-backdrop';
      lightboxEl.innerHTML = `
        <img class="lightbox-img" alt="">
        <button class="lightbox-close" aria-label="Close">×</button>
      `;
      document.body.appendChild(lightboxEl);
      lightboxImg = lightboxEl.querySelector('.lightbox-img');

      const close = () => {
        lightboxEl.classList.remove('open');
        lightboxImg.src = '';
        document.body.style.overflow = '';
        lightboxOpen = false;
      };

      lightboxEl.addEventListener('click', close);
      lightboxEl.querySelector('.lightbox-close').addEventListener('click', (e)=>{ e.stopPropagation(); close(); });
      document.addEventListener('keydown', (e)=>{
        if (!lightboxOpen) return;
        if (e.key === 'Escape'){ e.preventDefault(); close(); }
      });
      lightboxImg.addEventListener('click', (e)=> e.stopPropagation());
    }

    function openLightbox(url){
      if (!lightboxEl) setupLightbox();
      lightboxImg.src = url;
      lightboxEl.classList.add('open');
      document.body.style.overflow = 'hidden';
      lightboxOpen = true;
    }

    function enableLightbox(root){
      root.querySelectorAll('img').forEach(img=>{
        if(!img.hasAttribute('loading'))  img.setAttribute('loading','lazy');
        if(!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
        img.addEventListener('click', ()=>{
          const big = img.getAttribute('data-full') || img.currentSrc || img.src;
          if (big) openLightbox(big);
        });
      });
    }

    function postProcessStoryContent(root){
      root.querySelectorAll('audio').forEach(a=>{
        a.setAttribute('controls','');
        if(!a.hasAttribute('preload')) a.setAttribute('preload','metadata');
      });
      enableLightbox(root);
    }

    async function openStory(index){
      if(index<0 || index>=storyList.length) return;
      currentStoryIndex = index;
      const s = storyList[index];

      document.getElementById('story-title').textContent = s.title || '';
      document.getElementById('story-author').textContent = 'reported by';
      document.getElementById('story-role').textContent = s.author || '';

      try {
        const res = await fetch(s.html, { cache: 'no-cache' });
        const raw = await res.text();

        const clean = DOMPurify.sanitize(raw, {
          ADD_TAGS: ['audio','source','figure','figcaption','img','picture','a','hr'],
          ADD_ATTR: [
            'controls','preload','src','type','class','alt','title','width','height',
            'loading','decoding','srcset','sizes','media','href','data-full'
          ]
        });

        const target = document.getElementById('story-content');
        target.innerHTML = clean;
        postProcessStoryContent(target);
      } catch(e){
        document.getElementById('story-content').innerHTML = '<p>Unable to load story content.</p>';
      }

      document.getElementById('card-grid-area').classList.add('hidden');
      document.getElementById('story-reader-area').classList.remove('hidden');
      window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });

      document.title = (s.title ? s.title + ' - ' : '') + 'World C6H-ɛ Field Guide';
      updateStoryNavigation();
    }

    document.addEventListener('keydown', function(e){
      if (lightboxOpen) return;
      const storyVisible = !document.getElementById('story-reader-area').classList.contains('hidden');
      if (!storyVisible) return;

      const tgt = e.target;
      if (tgt && (tgt.tagName === 'INPUT' || tgt.tagName === 'TEXTAREA' || tgt.isContentEditable || tgt.closest('audio'))) return;

      if (e.key === 'ArrowLeft' && currentStoryIndex > 0){
        e.preventDefault(); navigateStory(-1);
      } else if (e.key === 'ArrowRight' && currentStoryIndex < storyList.length - 1){
        e.preventDefault(); navigateStory(1);
      }
    });

    /* ===== Behavioral Matrix (single-select) ===== */
    const BEHAVIOR_TAGS = [
      "Sense-making behavior analysis","Narrative creation patterns","Cultural interpretation variables",
      "Uncertainty cognition studies","Mythology-building responses","Contradiction and paradox",
      "Pattern seeking creation","Anthropomorphization tendency","Storytelling as meaning-making",
      "Individual versus collective response","Assigning agency to randomness","Fear versus wonder hierarchies",
      "False expertise claiming","Humor as dread defense","Isolation versus gathering",
      "Compulsive naming categorizing","Retrofitting familiar frameworks","Conspiracy theory creation",
      "Hope projection patterns","Memory reconstruction","Collective storytelling",
      "Authority figure seeking","Ritual creation","Social proof validation",
      "Future prediction attempts","Emotional contagion","Documentation obsession",
      "False memory creation","Weather anthropomorphization","Time perception distortion",
      "Scapegoat selection","Prediction obsession","Authority figure creation",
      "Fear performance","Wonder Guilt"
    ];

    const TAG_RULES = {
      "Sense-making behavior analysis":       [/make sense|work it all out/i],
      "Narrative creation patterns":          [/narrative|story/i],
      "Cultural interpretation variables":    [/custom|tradition|culture/i],
      "Uncertainty cognition studies":        [/uncertain|not sure|don'?t know|confus/i],
      "Mythology-building responses":         [/myth|legend|omen|prophe/i],
      "Contradiction and paradox":            [/paradox|contradiction/i],
      "Pattern seeking creation":             [/pattern|sign|coinciden/i],
      "Anthropomorphization tendency":        [/(sky|storm|lake|weather).*(wants|angry|calling|watching)/i],
      "Storytelling as meaning-making":       [/meaning.*(story|tell)/i],
      "Individual versus collective response":[/alone|together|crowd|gather/i],
      "Assigning agency to randomness":       [/fate|destiny|meant to/i],
      "Fear versus wonder hierarchies":       [/afraid|fear|terrified|awe|wonder/i],
      "False expertise claiming":             [/expert|i know better/i],
      "Humor as dread defense":               [/joke|laugh(ing)? at/i],
      "Isolation versus gathering":           [/isolation|alone|gather/i],
      "Compulsive naming categorizing":       [/name|label|categor/i],
      "Retrofitting familiar frameworks":     [/like (grandpa|father|before)|same as/i],
      "Conspiracy theory creation":           [/government|aliens|cover.?up|conspiracy/i],
      "Hope projection patterns":             [/hope|maybe it will|wish/i],
      "Memory reconstruction":                [/remember|memory|recollect/i],
      "Collective storytelling":              [/we (said|tell|saw)/i],
      "Authority figure seeking":             [/doctor|pastor|sheriff|leader|authority/i],
      "Ritual creation":                      [/ritual|every (morning|night)|again and again/i],
      "Social proof validation":              [/everyone|people say|they all/i],
      "Future prediction attempts":           [/predict|prophecy|going to happen|forecast/i],
      "Emotional contagion":                  [/panic|contagion/i],
      "Documentation obsession":              [/record|document|note|photo|film/i],
      "False memory creation":                [/remembered wrong|i swear it was/i],
      "Weather anthropomorphization":         [/\b(sky|cloud|storm|weather|front)\b.*(wants|angry|calling|watching)/i],
      "Time perception distortion":           [/time slowed|time stopped|lost time|distort/i],
      "Scapegoat selection":                  [/blame|scapegoat|witch/i],
      "Prediction obsession":                 [/prediction|odds|prophecy/i],
      "Authority figure creation":            [/made.*leader|follow(ed)? him|new chief/i],
      "Fear performance":                     [/act tough|fearless facade/i],
      "Wonder Guilt":                         [/shouldn'?t enjoy|guilty.*(beautiful|wonder)/i]
    };

    const STORY_TAGS = new Map();   // key: story.html -> [tags]
    let ACTIVE_TAG = '';
    let _taggedOnce = false;

    async function deriveTagsForStory(story){
      try{
        const res = await fetch(story.html, { cache:'no-cache' });
        const raw = await res.text();
        const tmp = document.createElement('div');
        tmp.innerHTML = raw;
        const text = (tmp.textContent || '').toLowerCase();
        const tags = [];
        for (const [tag, rules] of Object.entries(TAG_RULES)){
          const arr = Array.isArray(rules) ? rules : [rules];
          if (arr.some(rx => rx.test(text))) tags.push(tag);
        }
        STORY_TAGS.set(story.html, tags);
        return tags;
      }catch{ STORY_TAGS.set(story.html, []); return []; }
    }

    async function tagAllStories(){
      if (_taggedOnce) return;
      const tasks = (MANIFEST || []).map(async s=>{
        if (Array.isArray(s.tags)) { STORY_TAGS.set(s.html, s.tags.slice()); return; }
        await deriveTagsForStory(s);
      });
      await Promise.all(tasks);
      _taggedOnce = true;
    }

    function tagsForKey(key){
      const inManifest = MANIFEST.find(s => s.html === key);
      if (inManifest && Array.isArray(inManifest.tags)) return inManifest.tags;
      return STORY_TAGS.get(key) || [];
    }

    function renderMatrixPanel(){
      const panel = document.getElementById('matrix-panel');

      // counts
      const counts = new Map(BEHAVIOR_TAGS.map(t => [t, 0]));
      (MANIFEST || []).forEach(s => {
        tagsForKey(s.html).forEach(t => { if (counts.has(t)) counts.set(t, counts.get(t) + 1); });
      });

      const tiles = BEHAVIOR_TAGS.map(tag => {
        const c = counts.get(tag) || 0;
        const disabled = c === 0 ? 'disabled' : '';
        const isActive = (ACTIVE_TAG === tag);
        const esc = tag.replace(/"/g,'&quot;');
        return `
          <button class="matrix-tile" type="button" data-tag="${esc}" ${disabled}
            ${isActive ? 'style="border-color: var(--text-color); background: #fffdf7;"' : ''}>
            <span>${esc}</span>
            <span class="matrix-count">${c}</span>
          </button>`;
      }).join('');

      panel.innerHTML = `<div class="matrix-grid">${tiles}</div>`;

      // tap → apply & close
      panel.querySelectorAll('.matrix-tile').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.disabled) return;
          ACTIVE_TAG = btn.getAttribute('data-tag');
          filterCards();
          renderChip();
          document.querySelector('.behavioral-matrix').classList.remove('open'); // roll up
        });
      });
    }

    function renderChip(){
      const bar = document.getElementById('matrix-chipbar');
      if (!bar) return;
      bar.innerHTML = '';
      if (!ACTIVE_TAG){ bar.classList.remove('show'); return; }

      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      chip.innerHTML = `
        <span>Filtering: <strong>${ACTIVE_TAG}</strong></span>
        <button aria-label="Clear filter" title="Clear">×</button>
      `;
      chip.querySelector('button').onclick = () => {
        ACTIVE_TAG = '';
        filterCards();
        renderChip();
      };
      bar.appendChild(chip);
      bar.classList.add('show');
    }

    function filterCards(){
      const grid = document.getElementById('card-grid');
      Array.from(grid.children).forEach(card => {
        const key  = card.getAttribute('data-key');
        const tags = new Set(tagsForKey(key));
        const show = !ACTIVE_TAG || tags.has(ACTIVE_TAG);
        card.style.display = show ? '' : 'none';
      });
    }

    function toggleMatrixPanel(){
      const host = document.querySelector('.behavioral-matrix');
      const willOpen = !host.classList.contains('open');
      host.classList.toggle('open', willOpen);
      if (willOpen){
        tagAllStories().then(()=>{ renderMatrixPanel(); filterCards(); });
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      buildCards();
      setupLightbox();
      document.documentElement.style.scrollBehavior = 'smooth';

      const btn = document.querySelector('.behavioral-matrix .matrix-button');
      if (btn) btn.addEventListener('click', () => { toggleMatrixPanel(); });
    });

    window.openStory = openStory;
  })();
  </script>
  <script>
/* ===== Swarm helper: disperse on enter, snap back on leave ===== */
(function(){
  const RADIUS_MIN = 24;   // how far the closest dots can travel
  const RADIUS_MAX = 80;   // how far the farthest dots can travel
  const ANGLE_JITTER = 0.25; // adds a little off-axis randomness

  function setupCardSwarm(card){
    if (!card || card.__swarmReady) return;
    card.__swarmReady = true;

    const dots = Array.from(card.querySelectorAll('.card-dot'));
    if (!dots.length) return;

    const disperse = ()=>{
      card.classList.remove('sucking');
      for (const dot of dots){
        const a = (Math.random()*Math.PI*2) + (Math.random()-0.5)*ANGLE_JITTER;
        const r = RADIUS_MIN + Math.random()*(RADIUS_MAX - RADIUS_MIN);
        const dx = Math.cos(a)*r;
        const dy = Math.sin(a)*r;
        dot.style.transform = `translate(${dx}px, ${dy}px)`;
      }
    };

    const snapBack = ()=>{
      card.classList.add('sucking');   // uses faster return timing
      for (const dot of dots){
        dot.style.transform = 'translate(0,0)';
      }
      // clean up style class after transforms finish
      const onEnd = (e)=>{
        if (e.propertyName !== 'transform') return;
        card.removeEventListener('transitionend', onEnd, true);
        card.classList.remove('sucking');
      };
      card.addEventListener('transitionend', onEnd, true);
    };

    card.addEventListener('mouseenter', disperse);
    card.addEventListener('mouseleave', snapBack);
  }

  // 1) Attach to any cards that already exist
  document.querySelectorAll('.correspondent-card').forEach(setupCardSwarm);

  // 2) Watch for cards added later (your grid builds after manifest load)
  const grid = document.getElementById('card-grid');
  if (grid){
    const mo = new MutationObserver((muts)=>{
      for (const m of muts){
        m.addedNodes && m.addedNodes.forEach(node=>{
          if (node.nodeType === 1 && node.classList && node.classList.contains('correspondent-card')){
            setupCardSwarm(node);
          }
        });
      }
    });
    mo.observe(grid, { childList: true });
  }
})();
</script>
  <script>
(function(){
  const btn = document.querySelector('.fg-recruit-button');
  if(!btn) return;
  if(location.pathname.endsWith('/researchers.html') || location.pathname.endsWith('researchers.html')){
    btn.href = 'index.html';
    btn.textContent = '↩';
    btn.title = 'Back to Field Guide';
    btn.setAttribute('aria-label','Back to Field Guide');
  }
})();
</script>
  <a class="fg-recruit-button" href="recruit.html"
   aria-label="Become a researcher" title="Become a researcher">?</a>


</body>
</html>
